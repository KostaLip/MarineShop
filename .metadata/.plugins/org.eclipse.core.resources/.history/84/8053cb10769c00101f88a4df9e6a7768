package com.marine_shop.shop_backend.controllers;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.marine_shop.shop_backend.dto.CheckoutRequest;
import com.marine_shop.shop_backend.implementation.PaymentService;
import com.marine_shop.shop_backend.models.Order;
import com.marine_shop.shop_backend.models.Order.OrderStatus;
import com.marine_shop.shop_backend.models.Product;
import com.marine_shop.shop_backend.repository.OrderRepository;
import com.marine_shop.shop_backend.repository.ProductRepository;

@RestController
@RequestMapping("/payments")
@CrossOrigin(origins = "http://localhost:4200")
public class PaymentController {
	
	@Autowired
    private PaymentService paymentService;
	
	@Autowired
	private ProductRepository productRepository;
	
	@Autowired
	private OrderRepository orderRepository;

    @RequestMapping(value = "/create-checkout-session", method = RequestMethod.OPTIONS)
    public ResponseEntity<?> handleOptions() {
        return ResponseEntity.ok().build();
    }

    @PostMapping("/create-checkout-session")
    public ResponseEntity<Map<String, String>> createCheckoutSession(@RequestBody CheckoutRequest request) {
        try {
            System.out.println("=== CHECKOUT REQUEST DEBUG ===");
            System.out.println("Request received: " + request);
            
            String sessionUrl = paymentService.createCheckoutSession(request);
            
            Map<String, String> response = new HashMap<>();
            response.put("url", sessionUrl);
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            System.err.println("ERROR: " + e.getMessage());
            e.printStackTrace();
            
            Map<String, String> errorResponse = new HashMap<>();
            errorResponse.put("error", e.getMessage());
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
    
    @PostMapping("/confirm-order")
    public ResponseEntity<?> confirmOrder(@RequestBody Map<String, Object> request) {
        try {
            String sessionId = (String) request.get("sessionId");
            List<Map<String, Object>> items = (List<Map<String, Object>>) request.get("items");
            
            for (Map<String, Object> item : items) {
                int productId = Integer.valueOf(item.get("productId").toString());
                int quantity = Integer.valueOf(item.get("quantity").toString());
                
                Product product = productRepository.findById(productId).get();
                product.setStockQuantity(product.getStockQuantity() - quantity);
                productRepository.save(product);
            }
            
            Order order = orderRepository.findByStripeSessionId(sessionId).get();
            order.setStatus(OrderStatus.PAID);
            orderRepository.save(order);
            
            return ResponseEntity.ok("Order confirmed and stock updated");
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("Error: " + e.getMessage());
        }
    }
	
}
